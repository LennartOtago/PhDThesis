\chapter{Affine Approximation of the Non-Linear Model}
\label{ch:affine}
\newcommand*{\vertbar}{\rule[-1ex]{0.5pt}{2.5ex}}
\newcommand*{\horzbar}{\rule[.5ex]{2.5ex}{0.5pt}}


The forward map, which we introduce in Chapter~\ref{ch:formodel}, poses a weakly non-linear forward problem.
We could tackle the non-lin earity by treating the inverse problem as a linear inverse problem and then iteratively updating the non-linear part after each parameter sample.
Instead, as in Fig.~\ref{fig:AffSchem} illustrated, we approximate the non-linear model using an affine map $ \bm{M}:\bm{A}_L\bm{x} \rightarrow \bm{A}(\bm{x})$, which maps from the linear model $\bm{A}_{L}$ to the non-linear model $\bm{A}(\bm{x})$. \textcolor{red}{It is very unclear why you are introducing this here.}
Then we are able to define a linear model $ \bm{A} \coloneqq \bm{M} \bm{A}_{L}$, which approximates the non-linear model.
Here, we give a brief introduction to affine maps.

An affine map is any linear map between two vector spaces or affine spaces, where an affine space does not need to preserve a zero origin (see~\cite[Def. 2.3.1]{berger2009geometry}). \textcolor{red}{no it's not}
In other words, an affine map does not need to map to the origin of the associated vector space.
An affine map is a linear map on vector spaces, including a translation, or, in the words of my supervisor, C. F., a Taylor series of first order. \textcolor{red}{it is not a linear map , the origin of the domain to the origin of the range, fix this sentence - -it makes no sense.}
For more information on affine spaces and maps, we refer to the books~\cite{berger2009geometry, katsumi1994affine}. \textcolor{red}{don't say that, say that it is a linear map plus a constant.}
%\begin{figure}[ht!]
%	\centering
%	\begin{tikzpicture}
%		\node[rectnode] at (2,-4) (NL)    {$\bm{V}$};
%		\node[rectnode] at (-2,-4) (L)    {$\bm{W}$};
%		\draw[<-, very thick] (NL.west) -- (L.east); 
%		\node[align=center] at (-5.5,-4) (f3) {linear forward model};
%		\node[align=center] at (5.5,-4) (f4) {non-linear forward model};
%		\node[align=center] at (0,-5) (f5) {$\bm{A}(\bm{x})  \approx \bm{M A}_L  \bm{x} $ };
%		\node[align=center] at (0,-4) (f5) {affine Map \\ $\bm{M}$};
%	\end{tikzpicture}
%	\caption[Schematics of the affine map]{This figure shows the schematic representation of how the affine map $\bm{M}$ approximates the non-linear forward model. Here, $\bm{V}$ contains values produced by the linear forward model, and $\bm{W}$ contains the corresponding values from the non-linear forward model. Both $\bm{V}$ and $\bm{W}$ are affine subspaces over the same field. The affine map $\bm{M}$ projects elements from the linear forward model space $\bm{V}$ onto their counterparts in the non-linear forward model space $\bm{W}$. More specifically, the non-linear noise-free data vector $\bm{A} (\bm{x}) $ is approximated by the affine map and the linear forward model so that  $\bm{A} (\bm{x})  \approx  \bm{M A}_L  \bm{x}$.}
%	\label{fig:AffSchem}
%\end{figure}
\textcolor{red}{these are horrible books. No wonder you have a garbled idea and description. All affine maps look like y = Ax+b where A is linear and b is a constant. What's so difficult about that?
	I asked a LLM:
	Please give a simple definition of an affine map (between two vector spaces)
	Sure! A simple definition of an affine map between two vector spaces is:
	An affine map is a function between vector spaces that preserves straight lines and has the form
	$>f(x)=Ax+b>$
	where A is a linear transformation and b is a fixed vector.
	So itâ€™s like a linear map, but with a shift. }

Given the posterior distribution for ozone $ \pi(\bm{x}|\bm{y})$, we can now approximate the non-linear forward model 
\begin{align}
	\bm{A}(\bm{x}) \approx \bm{M A}_L \bm{x} \, ,
\end{align}
with an affine map $\bm{M}$ (see Fig.~\ref{fig:affinStrat} for the summarised strategy).
Here $\bm{A}(\bm{x})$ is non-linear noise-free data and $\bm{A}_L\bm{x}$ is linear noise-free data, both with ground truth pressure and temperature.
\begin{figure}[htb!]
	\centering
	\begin{tikzpicture}
		\node[rectnode] at (0,0) (Oy)    {$\bm{y}$};
		\node[roundnode2] at (0,-2) (x)     {$\bm{x}$};
		\node[roundnode2] at (1.75,-4) (V)    {$\bm{V}$};%{$\bm{A}_{NL}\bm{x}$};
		\node[roundnode2] at (-1.75,-4) (W)    {$\bm{W}$};%{$\bm{A}_L\bm{x}$};
		\draw[->, very thick] (Oy.south) -- (x.north); 
		\draw[->, very thick] (x) -- (V); 
		\draw[->, very thick] (x) -- (W); 
		\draw[->, very thick] (W.east) --  (V.west); 
		\node[align=center] at (1,0) (l1) {Data};
		\node[align=center] at (3.5,-2) (f2) {Ozone Profiles from $\pi(\bm{x}|\bm{y}) $};
		\node[align=center] at (1.75,-1) (l1) {$\pi(\lambda , \gamma  | \bm{y})$ with $\bm{A}_L$};
		
		
		\node[align=center] at (-4.25,-4) (f3) {linear forward model};
		\node[align=center] at (4.75,-4) (f4) {non-linear forward model};
		\node[align=center] at (0,-5) (f5) {$\bm{A}(\bm{x}) \approx \bm{M A}_L \bm{x}$ };
		
		\node[align=center] at (0,-4) (f5) {affine Map \\ $\bm{M}$};
		
	\end{tikzpicture}
	\caption[Strategy to find affine map.]{The strategy to find the affine map consists of first evaluating the marginal posterior for ozone $\pi(\lambda , \gamma  | \bm{y})$ based on the linear forward model. Then we draw ozone samples from the full posterior. Based on those ozone samples, we find an affine map which approximates between noise-free data from the linear and the non-linear forward model.}
	\label{fig:affinStrat}
\end{figure}


Using posterior ozone samples, we generate two affine subspaces and then find the mapping between those.
The subspace $\bm{W}$ is created by noise-free data based on the linear model and $\bm{V}$ by noise-free data based on the non-linear model, given $m$ samples $\bm{x}^{(j)} \sim \pi(\bm{x}|\bm{y})$ for $j = 1, \dots,m$.
We report a relative RMS difference between $\bm{W}$ and $\bm{V}$ of about $1\%$, which we aim to reduce through the affine map $\bm{M}$.
More specifically, the affine subspace associated with the linear forward model is 
\begin{align}
	\bm{W} = \begin{bmatrix}
		\vert&   &  \vert & & \vert \\
		\bm{A}_{L} \bm{x}^{(1)} &  \cdots& \bm{A}_{L} \bm{x}^{(j)} &  \cdots & \bm{A}_{L} \bm{x}^{(m)} \\
		\vert&   &  \vert & & \vert 
	\end{bmatrix}
	\in \mathbb{R}^{m \times m}
\end{align}\clearpage \noindent and with the non-linear forward model is 
\begin{align}
	\bm{V} = \begin{bmatrix}
		\vert&   &  \vert & & \vert \\
		\bm{A}(\bm{x}^{(1)}) &  \cdots& \bm{A}(\bm{x}^{(j)}) &  \cdots & \bm{A} (\bm{x}^{(m)})  \\
		\vert&   &  \vert & & \vert 
	\end{bmatrix} = 
	\begin{bmatrix}
		\begin{array}{ccc}
			\horzbar & v_{1} & \horzbar \\
			& \vdots    &          \\
			\horzbar & v_{j} & \horzbar \\
			& \vdots    &          \\
			\horzbar &v_{m} & \horzbar
		\end{array}
	\end{bmatrix}\in \mathbb{R}^{m \times m} \, .
\end{align}
Then we calculate the affine map 
\begin{align}
	\bm{V}\bm{W}^{-1} = \bm{M} =
	\begin{bmatrix}
		\begin{array}{ccc}
			\horzbar & r_{1} & \horzbar \\
			& \vdots    &          \\
			\horzbar & r_{j} & \horzbar \\
			& \vdots    &          \\
			\horzbar &r_{m} & \horzbar
		\end{array}
	\end{bmatrix}\, \in \mathbb{R}^{m \times m} .
\end{align}
by solving $v_j =r_j \bm{W}$ for each row $r_j$ in $\bm{M}$, where $j = 1, \dots, m$, using the Python function \texttt{numpy.linalg.solve}.
We can do that because every measurement in the data vector $\bm{y}$ is independent of each other, and then every row $v_j$ of $\bm{V} \in \mathbb{R}^{m \times m}$ is independent of each other as well.
%Alternatively, one can also determine this map using other methods, e.g. machine learning methods or matrix inversion, which in our case did not give better results.

We assess the affine map by calculating the relative RMS difference $\lVert \text{vec}(\bm{M}\bm{W}) - \text{vec}(\bm{V})  \rVert_{L^2} / \lVert \text{vec}(\bm{M}\bm{W}) \rVert_{L^2} $ between the mapped linear noise-free data and the non-linear noise-free data, which is approximately $0.001\%$.
\begin{figure}[t!]
	\centering
	%\includegraphics{SampMapAssesment.png}
	\includegraphics{SampMapAssesmentTT.png}
	\caption[Assessment of affine map.]{Assessment of how well we can approximate noise-free non-linear data $\bm{A}(\bm{x})$  (red circles) with noise-free linear data $\bm{A}_L\bm{x}$ (grey stars) and the previously calculated affine map $\bm{M}$. The approximated noise-free data (black stars) has a relative RMS error of $\approx 0.07\%$ compared to the true non-linear noise-free data.
		The ozone sample to generate this noise-free data has not been used to create the affine map.}
	\label{fig:MapAsses}
\end{figure}
In Fig.~\ref{fig:MapAsses}, we show the mapping for one posterior ozone sample, which has not been used to create this mapping.
In other words, this is an unseen event not occuring in the training data.
The relative RMS error for this approximation is roughly $0.07\%$ and much smaller than the relative difference between noise-free linear data and non-linear data.
Consequently, from here onwards, we use the approximated forward map.
\clearpage


